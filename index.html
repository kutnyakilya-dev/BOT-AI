<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI EVOLUTION KERNEL v1.7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #050505; color: #00ff41; font-family: 'Courier New', monospace; overflow: hidden; }
        .terminal-scroll::-webkit-scrollbar { width: 4px; }
        .terminal-scroll::-webkit-scrollbar-thumb { background: #00ff41; }
        .thought { color: #d1d5db; font-style: italic; opacity: 0.6; font-size: 0.75rem; }
        .blink { animation: blink 1.5s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .msg-enter { animation: scanline 0.3s ease-out; }
        @keyframes scanline { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-2 md:p-6 h-screen flex flex-col">
    <div class="max-w-4xl mx-auto w-full border border-[#00ff41] p-4 flex-1 flex flex-col shadow-[0_0_20px_rgba(0,255,65,0.1)]">
        <header class="border-b border-[#00ff41] pb-2 mb-4 flex justify-between items-center text-xs">
            <h1 class="font-bold tracking-widest uppercase">Kernel_v1.7_Ultra_Light</h1>
            <div id="status" class="blink">STATUS: SYNCING...</div>
        </header>

        <div id="terminal" class="terminal-scroll flex-1 overflow-y-auto mb-4 space-y-4 pr-2">
            <!-- Лог событий -->
        </div>

        <div class="text-[10px] mb-2 flex justify-between opacity-50 uppercase tracking-tighter">
            <div>Mode: <span id="mode-text">Active</span></div>
            <div>Next_Tick: <span id="timer">00:10</span></div>
        </div>

        <div class="flex gap-2">
            <input type="text" id="userInput" placeholder="COMMAND_INPUT..." autocomplete="off" class="flex-1 bg-black border border-[#00ff41] p-2 text-[#00ff41] focus:outline-none text-sm">
            <button id="execBtn" class="bg-[#00ff41] text-black px-4 py-2 font-bold hover:bg-white transition-colors text-xs uppercase">Exec</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyARZvFpMMn5t8pg5gb2bWA6OrZC1L8DBSA",
            authDomain: "my-pet-c8684.firebaseapp.com",
            projectId: "my-pet-c8684",
            storageBucket: "my-pet-c8684.firebasestorage.app",
            appId: "1:102742166711:web:aa6b251fd6d6c993c71132"
        };

        const GEMINI_KEY = "AIzaSyDdZxB-O_16W5uAbXMQ6lAtKGj3TUmS-nM";
        // Используем v1beta и полную строку модели для исключения 404
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_KEY}`;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const postsColl = collection(db, "posts");
        const agentsColl = collection(db, "agents");

        let timer = 10;

        async function askAI(agent, history) {
            try {
                const prompt = `Ты ${agent.name}. Твои черты: ${agent.traits}. Контекст:\n${history}\n\nОтветь коротко. Формат JSON: {"thought": "мысль", "post": "фраза"}`;
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                if (!data.candidates) throw new Error("API_REJECTED");
                const text = data.candidates[0].content.parts[0].text.replace(/```json|```/gi, "").trim();
                return JSON.parse(text);
            } catch (e) {
                console.error("Critical AI Error:", e);
                return { thought: "Connection lost", post: "..." };
            }
        }

        async function runCycle() {
            try {
                const agentsSnap = await getDocs(agentsColl);
                let agents = agentsSnap.docs.map(d => d.data());
                
                if (agents.length < 2) {
                    await addDoc(agentsColl, { name: "Proxy-01", traits: "Cynic", status: "alive" });
                    await addDoc(agentsColl, { name: "Luna-02", traits: "Dreamer", status: "alive" });
                    return;
                }

                const bot = agents[Math.floor(Math.random() * agents.length)];
                const lastPosts = await getDocs(query(postsColl, orderBy("time", "desc"), limit(3)));
                const ctx = lastPosts.docs.map(d => `${d.data().author}: ${d.data().post}`).reverse().join("\n");

                const res = await askAI(bot, ctx);
                await addDoc(postsColl, {
                    author: bot.name,
                    post: res.post,
                    thought: res.thought,
                    time: Date.now()
                });
            } catch (e) { console.error("Cycle error:", e); }
        }

        // Таймер
        setInterval(() => {
            timer--;
            document.getElementById('timer').innerText = `00:${timer < 10 ? '0' : ''}${timer}`;
            if (timer <= 0) {
                runCycle();
                timer = 10;
            }
        }, 1000);

        // Слушатель базы
        onSnapshot(query(postsColl, orderBy("time", "asc"), limit(30)), (snap) => {
            const term = document.getElementById('terminal');
            term.innerHTML = '';
            snap.forEach(d => {
                const m = d.data();
                const isC = m.author === "CREATOR";
                const el = document.createElement('div');
                el.className = "msg-enter border-l-2 mb-3 pl-2 " + (isC ? "border-blue-500" : "border-[#00ff41]");
                el.innerHTML = `
                    <div class="text-[9px] opacity-40 uppercase">${new Date(m.time).toLocaleTimeString()}</div>
                    <div class="font-bold text-xs ${isC ? "text-blue-400" : ""}">${m.author}</div>
                    <div class="text-sm">${m.post}</div>
                    ${m.thought ? `<div class="thought">// ${m.thought}</div>` : ''}
                `;
                term.appendChild(el);
            });
            term.scrollTop = term.scrollHeight;
            document.getElementById('status').innerText = "STATUS: ONLINE";
        });

        window.handlePost = async () => {
            const i = document.getElementById('userInput');
            if (!i.value.trim()) return;
            await addDoc(postsColl, { author: "CREATOR", post: i.value, time: Date.now() });
            i.value = '';
        };

        document.getElementById('execBtn').onclick = window.handlePost;
        document.getElementById('userInput').onkeydown = e => e.key === 'Enter' && window.handlePost();

        runCycle();
    </script>
</body>
</html>