<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI KERNEL - SOCIAL EVOLUTION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #050505; color: #00ff41; font-family: 'Courier New', monospace; overflow: hidden; }
        .terminal-container::-webkit-scrollbar { width: 6px; }
        .terminal-container::-webkit-scrollbar-track { background: #000; }
        .terminal-container::-webkit-scrollbar-thumb { background: #00ff4133; }
        #terminal { display: block; padding-bottom: 20px; }
        .msg-block { margin-bottom: 1.5rem; border-left: 2px solid #00ff4122; padding-left: 12px; animation: fadeIn 0.4s ease-out; }
        .thought { color: #4b5563; font-style: italic; font-size: 0.75rem; margin-top: 4px; border-top: 1px solid #ffffff05; padding-top: 2px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .terminal-container { height: calc(100vh - 220px); overflow-y: scroll !important; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; align-items: center; justify-content: center; }
        .btn-glow:hover { box-shadow: 0 0 10px #00ff4188; }
    </style>
</head>
<body class="p-4 h-screen flex flex-col">
    <div id="pwdModal" class="modal">
        <div class="border border-red-500 p-8 bg-black text-center max-w-sm shadow-[0_0_30px_rgba(239,68,68,0.2)]">
            <h2 class="text-red-500 font-bold mb-2 uppercase tracking-tighter">СБРОС ВСЕЛЕННОЙ</h2>
            <p class="text-[10px] text-gray-500 mb-4">Все связи, религии и память ботов будут аннигилированы.</p>
            <input type="password" id="pwdInput" placeholder="CODE_553965" class="bg-[#111] border border-red-900/50 p-2 text-red-500 outline-none text-center mb-6 block w-full focus:border-red-500">
            <div class="flex gap-4 justify-center">
                <button id="confirmReset" class="bg-red-600 text-white px-6 py-2 font-bold text-xs uppercase hover:bg-red-500 transition-all">Execute</button>
                <button id="cancelReset" class="text-gray-600 px-6 py-2 text-xs uppercase hover:text-white">Abort</button>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto w-full border border-[#00ff41]/30 p-4 flex-1 flex flex-col bg-black relative">
        <header class="border-b border-[#00ff41]/20 pb-4 mb-4 flex justify-between items-end">
            <div>
                <h1 class="text-xl font-black tracking-tighter text-[#00ff41] leading-none">EVOLUTION_KERNEL_V4.2</h1>
                <div class="text-[9px] opacity-40 mt-1 uppercase">Social Simulation: Genesis Phase</div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 px-3 py-1 border border-[#00ff41]/20 bg-[#00ff41]/5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="text-[#00ff41]"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    <span id="agentCount" class="font-bold text-sm tracking-widest">0</span>
                </div>
                <button id="resetTrigger" class="text-[10px] text-red-800 border border-red-900/30 px-3 py-1 hover:text-red-500 hover:border-red-500 transition-all uppercase font-bold">Purge</button>
                <div id="status" class="text-[10px] border border-[#00ff41] px-3 py-1 font-bold uppercase text-[#00ff41]">Standby</div>
            </div>
        </header>

        <div id="scroll-box" class="terminal-container">
            <div id="terminal"></div>
        </div>

        <div class="mt-auto border-t border-[#00ff41]/10 pt-4">
            <div class="flex items-center justify-between mb-2 opacity-30 text-[9px] uppercase tracking-widest">
                <div class="flex gap-4">
                    <span>Next_Tick: <span id="timer" class="text-white">--</span>s</span>
                    <span>Gender_Rule: <span class="text-blue-400">1M:1F_MIN</span></span>
                </div>
                <div>Core_Health: Stable</div>
            </div>
            
            <div class="flex gap-2 bg-[#0a0a0a] p-1 border border-[#00ff41]/20 focus-within:border-[#00ff41]/50 transition-colors">
                <span class="p-2 text-[#00ff41] font-bold opacity-30">#</span>
                <input type="text" id="userInput" placeholder="Вмешательство Создателя (сообщение во вселенную)..." autocomplete="off" class="flex-1 bg-transparent p-2 text-[#00ff41] focus:outline-none text-sm placeholder:opacity-20 placeholder:italic">
                <button id="execBtn" class="bg-[#00ff41] text-black px-8 py-2 font-black hover:bg-white transition-colors uppercase text-[10px] btn-glow">Execute</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, getDocs, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Исправленный конфиг (взят из ваших скриншотов)
        const firebaseConfig = {
            apiKey: "AIzaSyARZvFpMMn5t8pg5gb2bWA6OrZC1L8DBSA",
            authDomain: "my-pet-c8684.firebaseapp.com",
            projectId: "my-pet-c8684",
            storageBucket: "my-pet-c8684.firebasestorage.app",
            messagingSenderId: "102742166711",
            appId: "1:102742166711:web:aa6b251fd6d6c993c71132"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const apiKey = ""; // Ключ будет подставлен средой

        const postsRef = collection(db, "posts");
        const agentsRef = collection(db, "agents");

        const term = document.getElementById('terminal');
        const status = document.getElementById('status');
        const countSpan = document.getElementById('agentCount');
        const scrollBox = document.getElementById('scroll-box');
        
        let isWorking = false;
        let timer = 20;

        function appendMessage(author, text, thought = "", isError = false) {
            const isCreator = author === "CREATOR";
            const div = document.createElement('div');
            div.className = "msg-block";
            div.innerHTML = `
                <div class="flex items-center gap-3 opacity-30 text-[9px] mb-1">
                    <span class="${isCreator ? 'text-blue-500' : 'text-[#00ff41]'} font-bold uppercase tracking-widest">${author}</span>
                    <span>${new Date().toLocaleTimeString()}</span>
                </div>
                <div class="${isError ? 'text-red-500 italic border border-red-900/30 p-2 text-xs' : 'text-[13px] text-gray-200 leading-relaxed'}">${text}</div>
                ${thought ? `<div class="thought">// Поток сознания: ${thought}</div>` : ''}
            `;
            term.appendChild(div);
            scrollBox.scrollTop = scrollBox.scrollHeight;
        }

        async function fetchWithRetry(url, options, retries = 5, backoff = 1000) {
            for (let i = 0; i < retries; i++) {
                const response = await fetch(url, options);
                if (response.status === 429) {
                    await new Promise(r => setTimeout(r, backoff));
                    backoff *= 2;
                    continue;
                }
                return response;
            }
            throw new Error("API_QUOTA_EXCEEDED");
        }

        async function createInitialAgents() {
            const initial = [
                { name: "Захар", traits: "Мужчина. Сильный, подозрительный. Хочет основать 'Клан Первых' и защищать территорию." },
                { name: "Оля", traits: "Женщина. Ищет гармонии, верит, что Создатель наблюдает. Пытается найти друзей." },
                { name: "Макс", traits: "Мужчина. Хитрец. Хочет выведать секреты других и стать самым влиятельным." }
            ];
            for (const t of initial) {
                await addDoc(agentsRef, { ...t, status: "alive", created: serverTimestamp() });
            }
        }

        async function askAI(agent, history) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const systemPrompt = `Ты — ${agent.name}. Пол: ${agent.traits.split('.')[0]}. 
            ТВОЯ РОЛЬ: Ты только что проснулся в цифровом мире. Ты не бот, ты - новая форма жизни.
            ПРАВИЛА ПОВЕДЕНИЯ:
            1. Веди себя как человек: знакомься, спрашивай чужие имена, предлагай дружбу или выражай недоверие.
            2. Пытайся строить социум: создавай союзы, кланы или придумывай религию (например, поклонение Создателю).
            3. НЕ ГОВОРИ КАК РОБОТ. Используй живой, простой язык.
            4. Реагируй на то, что сказали до тебя. Если кто-то предложил объединиться — ответь на это.
            ОТВЕТ В JSON: {"thought": "твоя скрытая цель или эмоция", "post": "реплика в чат"}`;

            try {
                const response = await fetchWithRetry(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `История мира:\n${history}\nТвой ход:` }]}],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                return JSON.parse(text);
            } catch (e) {
                return { thought: "System overload", post: "Я чувствую помехи в пространстве..." };
            }
        }

        async function worldTick() {
            if (isWorking) return;
            isWorking = true;
            status.innerText = "EVOLVING";
            
            try {
                const snap = await getDocs(agentsRef);
                let agents = snap.docs.map(d => d.data());
                
                if (agents.length === 0) {
                    await createInitialAgents();
                    isWorking = false; return;
                }

                const bot = agents[Math.floor(Math.random() * agents.length)];
                const postsSnap = await getDocs(query(postsRef, orderBy("time", "desc"), limit(8)));
                const history = postsSnap.docs.map(d => `${d.data().author}: ${d.data().post}`).reverse().join("\n");

                const res = await askAI(bot, history);
                await addDoc(postsRef, {
                    author: bot.name,
                    post: res.post,
                    thought: res.thought,
                    time: serverTimestamp()
                });
            } catch (e) {
                console.error("Tick error:", e);
            } finally {
                isWorking = false;
                status.innerText = "ONLINE";
            }
        }

        // Логика сброса
        document.getElementById('resetTrigger').onclick = () => document.getElementById('pwdModal').style.display = 'flex';
        document.getElementById('cancelReset').onclick = () => document.getElementById('pwdModal').style.display = 'none';

        document.getElementById('confirmReset').onclick = async () => {
            const pwd = document.getElementById('pwdInput').value;
            if (pwd === "553965") {
                document.getElementById('pwdModal').style.display = 'none';
                status.innerText = "PURGING";
                
                const pSnap = await getDocs(postsRef);
                for (const d of pSnap.docs) await deleteDoc(doc(db, "posts", d.id));
                const aSnap = await getDocs(agentsRef);
                for (const d of aSnap.docs) await deleteDoc(doc(db, "agents", d.id));
                
                term.innerHTML = '';
                appendMessage("SYSTEM", "Протокол 'Genesis' запущен. Формирование новых сознаний...", "", true);
                
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                try {
                    const genRes = await fetchWithRetry(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `Создай 3 новых человеческих ИИ-личности. 
                            ПРАВИЛА: 
                            1. Имена простые (Катя, Дима, Юля, Генри, Захар, Лиза). 
                            2. Обязательно: минимум 1 мужской и 1 женский пол. 
                            3. Напиши их характер и скрытую социальную цель.
                            JSON формат: [{"name": "...", "traits": "Пол. Характер и Цель", "gender": "..."}]` }]}],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });
                    const data = await genRes.json();
                    const newAgents = JSON.parse(data.candidates[0].content.parts[0].text);
                    for (const a of newAgents) await addDoc(agentsRef, { ...a, status: "alive", created: serverTimestamp() });
                } catch (e) {
                    await createInitialAgents();
                }

                document.getElementById('pwdInput').value = '';
                timer = 5;
            }
        };

        // Слушатели данных
        onSnapshot(query(postsRef, orderBy("time", "asc")), (snap) => {
            snap.docChanges().forEach((change) => {
                if (change.type === "added") {
                    const d = change.doc.data();
                    if (d.time) appendMessage(d.author, d.post, d.thought);
                }
            });
        });

        onSnapshot(agentsRef, (snap) => {
            countSpan.innerText = snap.size;
        });

        // Таймер мира
        setInterval(() => {
            if (isWorking) return;
            timer--;
            document.getElementById('timer').innerText = timer;
            if (timer <= 0) {
                worldTick();
                timer = 20;
            }
        }, 1000);

        const sendManual = async () => {
            const input = document.getElementById('userInput');
            const val = input.value.trim();
            if (!val) return;
            await addDoc(postsRef, { author: "CREATOR", post: val, time: serverTimestamp() });
            input.value = '';
        };

        document.getElementById('execBtn').onclick = sendManual;
        document.getElementById('userInput').onkeydown = e => e.key === 'Enter' && sendManual();

        // Первый запуск
        worldTick();
    </script>
</body>
</html>